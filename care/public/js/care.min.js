!function(){"use strict";frappe.provide("care.care"),care.care.ReceivingController=frappe.ui.form.Controller.extend({setup:function(t,a,e){frappe.ui.form.on(this.frm.cscript.tax_table,"rate",function(t,a,e){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"tax_amount",function(t,a,e){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"row_id",function(t,a,e){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"included_in_print_rate",function(t,a,e){cur_frm.cscript.set_dynamic_labels(),cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype,"apply_discount_on",function(t){t.doc.additional_discount_percentage?t.trigger("additional_discount_percentage"):cur_frm.cscript.calculate_taxes_and_totals()})},onload:function(t,a,e){var o=this;this.frm.fields_dict.items.grid.get_field("item_code")&&this.frm.set_query("item_tax_template","items",function(t,a,e){return o.set_query_for_item_tax_template(t,a,e)})},onload_post_render:function(){var t=this;!this.frm.doc.__islocal||(this.frm.doc.taxes||[]).length||this.frm.doc.__onload&&this.frm.doc.__onload.load_after_mapping?this.frm.doc.__islocal&&this.frm.doc.company&&this.frm.doc.items&&!this.frm.doc.is_pos&&frappe.after_ajax(function(){return t.calculate_taxes_and_totals()}):frappe.after_ajax(function(){return t.apply_default_taxes()})},set_query_for_item_tax_template:function(t,a,e){var o=frappe.get_doc(a,e);if(o.item_code){var n={item_code:o.item_code,valid_from:["<=",t.transaction_date||t.bill_date||t.posting_date],item_group:o.item_group};return t.tax_category&&(n.tax_category=t.tax_category),t.company&&(n.company=t.company),{query:"erpnext.controllers.queries.get_tax_template",filters:n}}return t.company?{filters:{company:t.company}}:{}},apply_default_taxes:function(){var t=this,a=frappe.meta.get_docfield(t.frm.doc.doctype,"taxes_and_charges",t.frm.doc.name);if(!(!this.frm.doc.taxes_and_charges&&this.frm.doc.taxes&&this.frm.doc.taxes.length>0))return a?frappe.call({method:"erpnext.controllers.accounts_controller.get_default_taxes_and_charges",args:{master_doctype:a.options,tax_template:t.frm.doc.taxes_and_charges||"",company:t.frm.doc.company},debounce:2e3,callback:function(a){!a.exc&&a.message&&frappe.run_serially([function(){a.message.taxes_and_charges&&(t.frm.doc.taxes_and_charges=a.message.taxes_and_charges),a.message.taxes&&t.frm.set_value("taxes",a.message.taxes)},function(){return t.calculate_taxes_and_totals()}])}}):void 0},validate:function(){this.calculate_taxes_and_totals(!1)},taxes_and_charges:function(){var t=this;if(this.frm.doc.taxes_and_charges)return this.frm.call({method:"erpnext.controllers.accounts_controller.get_taxes_and_charges",args:{master_doctype:frappe.meta.get_docfield(this.frm.doc.doctype,"taxes_and_charges",this.frm.doc.name).options,master_name:this.frm.doc.taxes_and_charges},callback:function(a){if(!a.exc)if(t.frm.doc.shipping_rule&&t.frm.doc.taxes){for(var e=0,o=a.message;e<o.length;e+=1){var n=o[e];t.frm.add_child("taxes",n)}refresh_field("taxes")}else t.frm.set_value("taxes",a.message),t.calculate_taxes_and_totals()}})},calculate_taxes_and_totals:async function(t){this.discount_amount_applied=!1,this._calculate_taxes_and_totals(),this.calculate_discount_amount(),await this.calculate_shipping_charges(),in_list(["Sales Invoice","POS Invoice","Purchase Invoice"],this.frm.doc.doctype)&&this.frm.doc.docstatus<2&&!this.frm.doc.is_return&&this.calculate_total_advance(t),in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)&&this.frm.doc.is_pos&&this.frm.doc.is_return&&("Sales Invoice"==this.frm.doc.doctype&&this.set_total_amount_to_default_mop(),this.calculate_paid_amount()),this.frm.refresh_fields()},calculate_discount_amount:function(){frappe.meta.get_docfield(this.frm.doc.doctype,"discount_amount")&&(this.set_discount_amount(),this.apply_discount_amount())},_calculate_taxes_and_totals:function(){this.calculate_item_values(),this.initialize_taxes(),this.determine_exclusive_rate(),this.calculate_net_total(),this.calculate_taxes(),this.manipulate_grand_total_for_inclusive_tax(),this.calculate_totals(),this._cleanup()},item_tax_template:function(t,a,e){var o=this;if(!o.frm.updating_party_details){var n=frappe.get_doc(a,e);if(n.item_tax_template)return this.frm.call({method:"erpnext.stock.get_item_details.get_item_tax_map",args:{company:o.frm.doc.company,item_tax_template:n.item_tax_template,as_json:!0},callback:function(t){t.exc||(n.item_tax_rate=t.message,o.add_taxes_from_item_tax_template(n.item_tax_rate),o.calculate_taxes_and_totals())}});n.item_tax_rate="{}",o.calculate_taxes_and_totals()}},add_taxes_from_item_tax_template:function(t){var a=this;t&&cint(frappe.defaults.get_default("add_taxes_from_item_tax_template"))&&("string"==typeof t&&(t=JSON.parse(t)),$.each(t,function(t,e){if(!(a.frm.doc.taxes||[]).find(function(a){return a.account_head===t})){var o=frappe.model.add_child(a.frm.doc,"taxes");o.charge_type="On Net Total",o.account_head=t,o.rate=0}}))},calculate_item_values:function(){var t=this;this.discount_amount_applied||$.each(this.frm.doc.items||[],function(a,e){frappe.model.round_floats_in(e),e.net_rate=e.rate,!e.qty&&t.frm.doc.is_return?e.amount=flt(-1*e.rate,precision("amount",e)):!e.qty&&t.frm.doc.is_debit_note?e.amount=flt(e.rate,precision("amount",e)):e.amount=flt(e.rate*e.qty,precision("amount",e)),e.net_amount=e.amount,e.item_tax_amount=0,e.total_weight=flt(e.weight_per_unit*e.stock_qty),t.set_in_company_currency(e,["price_list_rate","rate","amount","net_rate","net_amount"])})},set_in_company_currency:function(t,a){var e=this;$.each(a,function(a,o){t["base_"+o]=flt(flt(t[o],precision(o,t))*e.frm.doc.conversion_rate,precision("base_"+o,t))})},initialize_taxes:function(){var t=this;$.each(this.frm.doc.taxes||[],function(a,e){e.dont_recompute_tax||(e.item_wise_tax_detail={});var o=["total","tax_amount_after_discount_amount","tax_amount_for_current_item","grand_total_for_current_item","tax_fraction_for_current_item","grand_total_fraction_for_current_item"];"Actual"==cstr(e.charge_type)||t.discount_amount_applied&&"Grand Total"==t.frm.doc.apply_discount_on||o.push("tax_amount"),$.each(o,function(t,a){e[a]=0}),frappe.model.round_floats_in(e)})},fetch_round_off_accounts:function(){if(frappe.flags.round_off_applicable_accounts=[],this.frm.doc.company)return frappe.call({method:"erpnext.controllers.taxes_and_totals.get_round_off_applicable_accounts",args:{company:this.frm.doc.company,account_list:frappe.flags.round_off_applicable_accounts},callback:function(t){var a;(a=frappe.flags.round_off_applicable_accounts).push.apply(a,t.message)}})},determine_exclusive_rate:function(){var t=this,a=!1;$.each(t.frm.doc.taxes||[],function(t,e){cint(e.included_in_print_rate)&&(a=!0)}),0!=a&&$.each(t.frm.doc.items||[],function(a,e){var o=t._load_item_tax_rate(e.item_tax_rate),n=0,_=0;if($.each(t.frm.doc.taxes||[],function(a,r){var i=t.get_current_tax_fraction(r,o);r.tax_fraction_for_current_item=i[0];var c=i[1];r.grand_total_fraction_for_current_item=0==a?1+r.tax_fraction_for_current_item:t.frm.doc.taxes[a-1].grand_total_fraction_for_current_item+r.tax_fraction_for_current_item,n+=r.tax_fraction_for_current_item,_+=c*flt(e.qty)}),!t.discount_amount_applied&&e.qty&&(_||n)){var r=flt(e.amount)-_;e.net_amount=flt(r/(1+n)),e.net_rate=e.qty?flt(e.net_amount/e.qty,precision("net_rate",e)):0,t.set_in_company_currency(e,["net_rate","net_amount"])}})},get_current_tax_fraction:function(t,a){var e=0,o=0;if(cint(t.included_in_print_rate)){var n=this._get_tax_rate(t,a);"On Net Total"==t.charge_type?e=n/100:"On Previous Row Amount"==t.charge_type?e=n/100*this.frm.doc.taxes[cint(t.row_id)-1].tax_fraction_for_current_item:"On Previous Row Total"==t.charge_type?e=n/100*this.frm.doc.taxes[cint(t.row_id)-1].grand_total_fraction_for_current_item:"On Item Quantity"==t.charge_type&&(o=flt(n))}return t.add_deduct_tax&&"Deduct"==t.add_deduct_tax&&(e*=-1,o*=-1),[e,o]},_get_tax_rate:function(t,a){return-1!=Object.keys(a).indexOf(t.account_head)?flt(a[t.account_head],precision("rate",t)):t.rate},calculate_net_total:function(){var t=this;this.frm.doc.total_qty=this.frm.doc.total=this.frm.doc.base_total=this.frm.doc.net_total=this.frm.doc.base_net_total=0,$.each(this.frm.doc.items||[],function(a,e){t.frm.doc.total+=e.amount,t.frm.doc.total_qty+=e.qty,t.frm.doc.base_total+=e.base_amount,t.frm.doc.net_total+=e.net_amount,t.frm.doc.base_net_total+=e.base_net_amount})},calculate_shipping_charges:function(){if(!this.frm.doc.is_pos)return frappe.model.round_floats_in(this.frm.doc,["total","base_total","net_total","base_net_total"]),frappe.meta.get_docfield(this.frm.doc.doctype,"shipping_rule",this.frm.doc.name)?this.shipping_rule():void 0},calculate_taxes:function(){var t=this;this.frm.doc.rounding_adjustment=0;var a={};$.each(this.frm.doc.taxes||[],function(t,e){"Actual"==e.charge_type&&(a[e.idx]=flt(e.tax_amount,precision("tax_amount",e)))}),$.each(this.frm.doc.items||[],function(e,o){var n=t._load_item_tax_rate(o.item_tax_rate);$.each(t.frm.doc.taxes||[],function(_,r){var i=t.get_current_tax_amount(o,r,n);"Actual"==r.charge_type&&(a[r.idx]-=i,e==t.frm.doc.items.length-1&&(i+=a[r.idx])),"Actual"==r.charge_type||t.discount_amount_applied&&"Grand Total"==t.frm.doc.apply_discount_on||(r.tax_amount+=i),r.tax_amount_for_current_item=i,r.tax_amount_after_discount_amount+=i,r.category&&(i="Valuation"==r.category?0:i,i*="Deduct"==r.add_deduct_tax?-1:1),r.grand_total_for_current_item=0==_?flt(o.net_amount+i):flt(t.frm.doc.taxes[_-1].grand_total_for_current_item+i),e==t.frm.doc.items.length-1&&(t.set_in_company_currency(r,["tax_amount","tax_amount_after_discount_amount"]),t.set_cumulative_total(_,r),t.set_in_company_currency(r,["total"]),_==t.frm.doc.taxes.length-1&&t.discount_amount_applied&&"Grand Total"==t.frm.doc.apply_discount_on&&t.frm.doc.discount_amount&&(t.frm.doc.rounding_adjustment=flt(t.frm.doc.grand_total-flt(t.frm.doc.discount_amount)-r.total,precision("rounding_adjustment"))))})})},set_cumulative_total:function(t,a){var e=a.tax_amount_after_discount_amount;"Valuation"==a.category&&(e=0),"Deduct"==a.add_deduct_tax&&(e*=-1),a.total=0==t?flt(this.frm.doc.net_total+e,precision("total",a)):flt(this.frm.doc.taxes[t-1].total+e,precision("total",a))},_load_item_tax_rate:function(t){return t?JSON.parse(t):{}},get_current_tax_amount:function(t,a,e){var o=this._get_tax_rate(a,e),n=0;if(["On Previous Row Amount","On Previous Row Total"].includes(a.charge_type)&&(1===a.idx&&frappe.throw(__("Cannot select charge type as 'On Previous Row Amount' or 'On Previous Row Total' for first row")),a.row_id||(a.row_id=a.idx-1)),"Actual"==a.charge_type){var _=flt(a.tax_amount,precision("tax_amount",a));n=this.frm.doc.net_total?t.net_amount/this.frm.doc.net_total*_:0}else"On Net Total"==a.charge_type?n=o/100*t.net_amount:"On Previous Row Amount"==a.charge_type?n=o/100*this.frm.doc.taxes[cint(a.row_id)-1].tax_amount_for_current_item:"On Previous Row Total"==a.charge_type?n=o/100*this.frm.doc.taxes[cint(a.row_id)-1].grand_total_for_current_item:"On Item Quantity"==a.charge_type&&(n=o*t.qty);return a.dont_recompute_tax||this.set_item_wise_tax(t,a,o,n),n},set_item_wise_tax:function(t,a,e,o){var n=a.item_wise_tax_detail,_=t.item_code||t.item_name;"string"==typeof n&&(a.item_wise_tax_detail=JSON.parse(a.item_wise_tax_detail),n=a.item_wise_tax_detail);var r=o*this.frm.doc.conversion_rate;n&&n[_]&&(r+=n[_][1]),n[_]=[e,flt(r,precision("base_tax_amount",a))]},manipulate_grand_total_for_inclusive_tax:function(){var t=this;if(this.frm.doc.taxes&&this.frm.doc.taxes.length){var a=!1;if($.each(this.frm.doc.taxes||[],function(t,e){cint(e.included_in_print_rate)&&(a=!0)}),a){var e=t.frm.doc.taxes.slice(-1)[0],o=frappe.utils.sum($.map(this.frm.doc.taxes||[],function(t){if(!t.included_in_print_rate)return flt(t.tax_amount_after_discount_amount)})),n=t.frm.doc.total+o-flt(e.total,precision("grand_total"));t.discount_amount_applied&&t.frm.doc.discount_amount&&(n-=flt(t.frm.doc.discount_amount)),(n=flt(n,precision("rounding_adjustment")))&&Math.abs(n)<=5/Math.pow(10,precision("tax_amount",e))&&(t.frm.doc.rounding_adjustment=n)}}},calculate_totals:function(){var t=this,a=this.frm.doc.taxes?this.frm.doc.taxes.length:0;this.frm.doc.grand_total=flt(a?this.frm.doc.taxes[a-1].total+flt(this.frm.doc.rounding_adjustment):this.frm.doc.net_total),in_list(["Quotation","Sales Order","Delivery Note","Sales Invoice","POS Invoice"],this.frm.doc.doctype)?this.frm.doc.base_grand_total=this.frm.doc.total_taxes_and_charges?flt(this.frm.doc.grand_total*this.frm.doc.conversion_rate):this.frm.doc.base_net_total:(this.frm.doc.taxes_and_charges_added=this.frm.doc.taxes_and_charges_deducted=0,a&&($.each(this.frm.doc.taxes||[],function(a,e){in_list(["Valuation and Total","Total"],e.category)&&("Add"==e.add_deduct_tax?t.frm.doc.taxes_and_charges_added+=flt(e.tax_amount_after_discount_amount):t.frm.doc.taxes_and_charges_deducted+=flt(e.tax_amount_after_discount_amount))}),frappe.model.round_floats_in(this.frm.doc,["taxes_and_charges_added","taxes_and_charges_deducted"])),this.frm.doc.base_grand_total=flt(this.frm.doc.taxes_and_charges_added||this.frm.doc.taxes_and_charges_deducted?flt(this.frm.doc.grand_total*this.frm.doc.conversion_rate):this.frm.doc.base_net_total),this.set_in_company_currency(this.frm.doc,["taxes_and_charges_added","taxes_and_charges_deducted"])),this.frm.doc.total_taxes_and_charges=flt(this.frm.doc.grand_total-this.frm.doc.net_total-flt(this.frm.doc.rounding_adjustment),precision("total_taxes_and_charges")),this.set_in_company_currency(this.frm.doc,["total_taxes_and_charges","rounding_adjustment"]),frappe.model.round_floats_in(this.frm.doc,["grand_total","base_grand_total"]),this.set_rounded_total()},set_rounded_total:function(){var t=0;if(frappe.meta.get_docfield(this.frm.doc.doctype,"disable_rounded_total",this.frm.doc.name)?t=this.frm.doc.disable_rounded_total:frappe.sys_defaults.disable_rounded_total&&(t=frappe.sys_defaults.disable_rounded_total),cint(t))return this.frm.doc.rounded_total=0,void(this.frm.doc.base_rounded_total=0);frappe.meta.get_docfield(this.frm.doc.doctype,"rounded_total",this.frm.doc.name)&&(this.frm.doc.rounded_total=round_based_on_smallest_currency_fraction(this.frm.doc.grand_total,this.frm.doc.currency,precision("rounded_total")),this.frm.doc.rounding_adjustment+=flt(this.frm.doc.rounded_total-this.frm.doc.grand_total,precision("rounding_adjustment")),this.set_in_company_currency(this.frm.doc,["rounding_adjustment","rounded_total"]))},_cleanup:function(){if(this.frm.doc.base_in_words=this.frm.doc.in_words="",this.frm.doc.items&&this.frm.doc.items.length&&(frappe.meta.get_docfield(this.frm.doc.items[0].doctype,"item_tax_amount",this.frm.doctype)||$.each(this.frm.doc.items||[],function(t,a){delete a.item_tax_amount})),this.frm.doc.taxes&&this.frm.doc.taxes.length){var t=["tax_amount_for_current_item","grand_total_for_current_item","tax_fraction_for_current_item","grand_total_fraction_for_current_item"];frappe.meta.get_docfield(this.frm.doc.taxes[0].doctype,"tax_amount_after_discount_amount",this.frm.doctype)||t.push("tax_amount_after_discount_amount"),$.each(this.frm.doc.taxes||[],function(a,e){$.each(t,function(t,a){delete e[a]}),e.dont_recompute_tax||(e.item_wise_tax_detail=JSON.stringify(e.item_wise_tax_detail))})}},set_discount_amount:function(){this.frm.doc.additional_discount_percentage&&(this.frm.doc.discount_amount=flt(flt(this.frm.doc[frappe.scrub(this.frm.doc.apply_discount_on)])*this.frm.doc.additional_discount_percentage/100,precision("discount_amount")))},apply_discount_amount:function(){var t=this,a=0;if(this.frm.doc.base_discount_amount=0,this.frm.doc.discount_amount){this.frm.doc.apply_discount_on||frappe.throw(__("Please select Apply Discount On")),this.frm.doc.base_discount_amount=flt(this.frm.doc.discount_amount*this.frm.doc.conversion_rate,precision("base_discount_amount"));var e=this.get_total_for_discount_amount(),o=0;e&&($.each(this.frm.doc.items||[],function(n,_){if(a=flt(t.frm.doc.discount_amount)*_.net_amount/e,_.net_amount=flt(_.net_amount-a,precision("base_amount",_)),o+=_.net_amount,(!(t.frm.doc.taxes||[]).length||e==t.frm.doc.net_total||"Net Total"==t.frm.doc.apply_discount_on)&&n==(t.frm.doc.items||[]).length-1){var r=flt(t.frm.doc.net_total-o-t.frm.doc.discount_amount,precision("net_total"));_.net_amount=flt(_.net_amount+r,precision("net_amount",_))}_.net_rate=_.qty?flt(_.net_amount/_.qty,precision("net_rate",_)):0,t.set_in_company_currency(_,["net_rate","net_amount"])}),this.discount_amount_applied=!0,this._calculate_taxes_and_totals())}},get_total_for_discount_amount:function(){if("Net Total"==this.frm.doc.apply_discount_on)return this.frm.doc.net_total;var t=0,a={};return $.each(this.frm.doc.taxes||[],function(t,e){if(in_list(["Actual","On Item Quantity"],e.charge_type)){var o="Valuation"==e.category?0:e.tax_amount;o*="Deduct"==e.add_deduct_tax?-1:1,a[e.idx]=o}else if(null!==a[e.row_id]){var n=flt(a[e.row_id])*flt(e.rate)/100;a[e.idx]=n}}),$.each(a,function(a,e){e&&(t+=e)}),flt(this.frm.doc.grand_total-t,precision("grand_total"))},calculate_total_advance:function(t){var a=frappe.utils.sum($.map(this.frm.doc.advances||[],function(t){return flt(t.allocated_amount,precision("allocated_amount",t))}));this.frm.doc.total_advance=flt(a,precision("total_advance")),this.frm.doc.write_off_outstanding_amount_automatically&&(this.frm.doc.write_off_amount=0),this.calculate_outstanding_amount(t),this.calculate_write_off_amount()},is_internal_invoice:function(){return!(!["Sales Invoice","Purchase Invoice"].includes(this.frm.doc.doctype)||this.frm.doc.company!==this.frm.doc.represents_company)},calculate_outstanding_amount:function(t){if(in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)&&this.frm.doc.is_return&&this.calculate_paid_amount(),!(this.frm.doc.is_return||this.frm.doc.docstatus>0||this.is_internal_invoice())&&(frappe.model.round_floats_in(this.frm.doc,["grand_total","total_advance","write_off_amount"]),in_list(["Sales Invoice","POS Invoice","Purchase Invoice"],this.frm.doc.doctype))){var a=this.frm.doc.rounded_total||this.frm.doc.grand_total,e=this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total;if(this.frm.doc.party_account_currency==this.frm.doc.currency)var o=flt(a-this.frm.doc.total_advance-this.frm.doc.write_off_amount,precision("grand_total"));else o=flt(flt(e,precision("base_grand_total"))-this.frm.doc.total_advance-this.frm.doc.base_write_off_amount,precision("base_grand_total"));if(frappe.model.round_floats_in(this.frm.doc,["paid_amount"]),this.set_in_company_currency(this.frm.doc,["paid_amount"]),this.frm.refresh_field&&(this.frm.refresh_field("paid_amount"),this.frm.refresh_field("base_paid_amount")),in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)){var n=this.frm.doc.redeem_loyalty_points&&this.frm.doc.loyalty_amount?flt(o-this.frm.doc.loyalty_amount,precision("base_grand_total")):o;this.set_default_payment(n,t),this.calculate_paid_amount()}this.calculate_change_amount();var _=this.frm.doc.party_account_currency==this.frm.doc.currency?this.frm.doc.paid_amount:this.frm.doc.base_paid_amount;this.frm.doc.outstanding_amount=flt(o-flt(_)+flt(this.frm.doc.change_amount*this.frm.doc.conversion_rate),precision("outstanding_amount"))}},set_total_amount_to_default_mop:function(){var t=this.frm.doc.rounded_total||this.frm.doc.grand_total,a=this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total;if(this.frm.doc.party_account_currency==this.frm.doc.currency)var e=flt(t-this.frm.doc.total_advance-this.frm.doc.write_off_amount,precision("grand_total"));else e=flt(flt(a,precision("base_grand_total"))-this.frm.doc.total_advance-this.frm.doc.base_write_off_amount,precision("base_grand_total"));this.frm.doc.payments.find(function(t){t.default&&(t.amount=e)}),this.frm.refresh_fields()},set_default_payment:function(t,a){var e=this,o=!0;this.frm.doc.is_pos&&(void 0===a||a)&&$.each(this.frm.doc.payments||[],function(a,n){if(n.default&&o&&t>0){var _=flt(t,precision("base_amount",n));frappe.model.set_value(n.doctype,n.name,"base_amount",_);var r=flt(t/e.frm.doc.conversion_rate,precision("amount",n));frappe.model.set_value(n.doctype,n.name,"amount",r),o=!1}else e.frm.doc.paid_amount&&frappe.model.set_value(n.doctype,n.name,"amount",0)})},calculate_paid_amount:function(){var t=this,a=0,e=0;this.frm.doc.is_pos?$.each(this.frm.doc.payments||[],function(o,n){n.base_amount=flt(n.amount*t.frm.doc.conversion_rate,precision("base_amount",n)),a+=n.amount,e+=n.base_amount}):this.frm.doc.is_return||(this.frm.doc.payments=[]),this.frm.doc.redeem_loyalty_points&&this.frm.doc.loyalty_amount&&(e+=this.frm.doc.loyalty_amount,a+=flt(this.frm.doc.loyalty_amount/t.frm.doc.conversion_rate,precision("paid_amount"))),this.frm.set_value("paid_amount",flt(a,precision("paid_amount"))),this.frm.set_value("base_paid_amount",flt(e,precision("base_paid_amount")))},calculate_change_amount:function(){if(this.frm.doc.change_amount=0,this.frm.doc.base_change_amount=0,in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)&&this.frm.doc.paid_amount>this.frm.doc.grand_total&&!this.frm.doc.is_return){var t=$.map(this.frm.doc.payments,function(t){return t.type});if(in_list(t,"Cash")){var a=this.frm.doc.rounded_total||this.frm.doc.grand_total,e=this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total;this.frm.doc.change_amount=flt(this.frm.doc.paid_amount-a,precision("change_amount")),this.frm.doc.base_change_amount=flt(this.frm.doc.base_paid_amount-e,precision("base_change_amount"))}}},calculate_write_off_amount:function(){this.frm.doc.write_off_outstanding_amount_automatically&&(this.frm.doc.write_off_amount=flt(this.frm.doc.outstanding_amount,precision("write_off_amount")),this.frm.doc.base_write_off_amount=flt(this.frm.doc.write_off_amount*this.frm.doc.conversion_rate,precision("base_write_off_amount")),this.calculate_outstanding_amount(!1))}})}();
//# sourceMappingURL=care.min.js.map
