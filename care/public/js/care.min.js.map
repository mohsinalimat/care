{"version":3,"file":"care.min.js","sources":["../../../../apps/care/care/public/js/tax_contoller.js"],"sourcesContent":["// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\n\n\nfrappe.provide(\"care.care\");\n\ncare.care.ReceivingController = frappe.ui.form.Controller.extend({\n    setup: function(frm, cdt, cdn) {\n        var me = this;\n        frappe.ui.form.on(this.frm.cscript.tax_table, \"rate\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.cscript.tax_table, \"tax_amount\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.cscript.tax_table, \"row_id\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.cscript.tax_table, \"included_in_print_rate\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.set_dynamic_labels();\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.doctype, \"apply_discount_on\", function(frm) {\n\t\t\tif(frm.doc.additional_discount_percentage) {\n\t\t\t\tfrm.trigger(\"additional_discount_percentage\");\n\t\t\t} else {\n\t\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t\t}\n\t\t});\n    },\n    onload: function(doc, cdt, cdn){\n        var me = this;\n        if(this.frm.fields_dict[\"items\"].grid.get_field('item_code')) {\n\t\t\tthis.frm.set_query(\"item_tax_template\", \"items\", function(doc, cdt, cdn) {\n\t\t\t\treturn me.set_query_for_item_tax_template(doc, cdt, cdn)\n\t\t\t});\n\t\t}\n    },\n    onload_post_render: function() {\n\t\tif(this.frm.doc.__islocal && !(this.frm.doc.taxes || []).length\n\t\t\t&& !(this.frm.doc.__onload ? this.frm.doc.__onload.load_after_mapping : false)) {\n\t\t\tfrappe.after_ajax(() => this.apply_default_taxes());\n\t\t} else if(this.frm.doc.__islocal && this.frm.doc.company && this.frm.doc[\"items\"]\n\t\t\t&& !this.frm.doc.is_pos) {\n\t\t\tfrappe.after_ajax(() => this.calculate_taxes_and_totals());\n\t\t}\n\t},\n\tset_query_for_item_tax_template: function(doc, cdt, cdn) {\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tif(!item.item_code) {\n\t\t\treturn doc.company ? {filters: {company: doc.company}} : {};\n\t\t} else {\n\t\t\tlet filters = {\n\t\t\t\t'item_code': item.item_code,\n\t\t\t\t'valid_from': [\"<=\", doc.transaction_date || doc.bill_date || doc.posting_date],\n\t\t\t\t'item_group': item.item_group,\n\t\t\t}\n\n\t\t\tif (doc.tax_category)\n\t\t\t\tfilters['tax_category'] = doc.tax_category;\n\t\t\tif (doc.company)\n\t\t\t\tfilters['company'] = doc.company;\n\t\t\treturn {\n\t\t\t\tquery: \"erpnext.controllers.queries.get_tax_template\",\n\t\t\t\tfilters: filters\n\t\t\t}\n\t\t}\n\t},\n\tapply_default_taxes() {\n\t\tvar me = this;\n\t\tvar taxes_and_charges_field = frappe.meta.get_docfield(me.frm.doc.doctype, \"taxes_and_charges\",\n\t\t\tme.frm.doc.name);\n\n\t\tif (!this.frm.doc.taxes_and_charges && this.frm.doc.taxes && this.frm.doc.taxes.length > 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (taxes_and_charges_field) {\n\t\t\treturn frappe.call({\n\t\t\t\tmethod: \"erpnext.controllers.accounts_controller.get_default_taxes_and_charges\",\n\t\t\t\targs: {\n\t\t\t\t\t\"master_doctype\": taxes_and_charges_field.options,\n\t\t\t\t\t\"tax_template\": me.frm.doc.taxes_and_charges || \"\",\n\t\t\t\t\t\"company\": me.frm.doc.company\n\t\t\t\t},\n\t\t\t\tdebounce: 2000,\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc && r.message) {\n\t\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t// directly set in doc, so as not to call triggers\n\t\t\t\t\t\t\t\tif(r.message.taxes_and_charges) {\n\t\t\t\t\t\t\t\t\tme.frm.doc.taxes_and_charges = r.message.taxes_and_charges;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t// set taxes table\n\t\t\t\t\t\t\t\tif(r.message.taxes) {\n\t\t\t\t\t\t\t\t\tme.frm.set_value(\"taxes\", r.message.taxes);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t() => me.calculate_taxes_and_totals()\n\t\t\t\t\t\t]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\tvalidate: function() {\n\t\tthis.calculate_taxes_and_totals(false);\n\t},\n\ttaxes_and_charges: function() {\n\t\tvar me = this;\n\t\tif(this.frm.doc.taxes_and_charges) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.controllers.accounts_controller.get_taxes_and_charges\",\n\t\t\t\targs: {\n\t\t\t\t\t\"master_doctype\": frappe.meta.get_docfield(this.frm.doc.doctype, \"taxes_and_charges\",\n\t\t\t\t\t\tthis.frm.doc.name).options,\n\t\t\t\t\t\"master_name\": this.frm.doc.taxes_and_charges\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\tif(me.frm.doc.shipping_rule && me.frm.doc.taxes) {\n\t\t\t\t\t\t\tfor (let tax of r.message) {\n\t\t\t\t\t\t\t\tme.frm.add_child(\"taxes\", tax);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\trefresh_field(\"taxes\");\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tme.frm.set_value(\"taxes\", r.message);\n\t\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\tcalculate_taxes_and_totals: async function(update_paid_amount) {\n\t\tthis.discount_amount_applied = false;\n\t\tthis._calculate_taxes_and_totals();\n\t\tthis.calculate_discount_amount();\n\n\t\tawait this.calculate_shipping_charges();\n\n//\t\t Advance calculation applicable to Sales /Purchase Invoice\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\", \"Purchase Invoice\"], this.frm.doc.doctype)\n\t\t\t&& this.frm.doc.docstatus < 2 && !this.frm.doc.is_return) {\n\t\t\tthis.calculate_total_advance(update_paid_amount);\n\t\t}\n\n\t\tif (in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype) && this.frm.doc.is_pos &&\n\t\t\tthis.frm.doc.is_return) {\n\t\t\tif (this.frm.doc.doctype == \"Sales Invoice\") {\n\t\t\t\tthis.set_total_amount_to_default_mop();\n\t\t\t}\n\t\t\tthis.calculate_paid_amount();\n\t\t}\n\t\tthis.frm.refresh_fields();\n\t},\n\n\tcalculate_discount_amount: function() {\n\t\tif (frappe.meta.get_docfield(this.frm.doc.doctype, \"discount_amount\")) {\n\t\t\tthis.set_discount_amount();\n\t\t\tthis.apply_discount_amount();\n\t\t}\n\t},\n\n\t_calculate_taxes_and_totals: function() {\n\t\tthis.calculate_item_values();\n\t\tthis.initialize_taxes();\n\t\tthis.determine_exclusive_rate();\n\t\tthis.calculate_net_total();\n\t\tthis.calculate_taxes();\n\t\tthis.manipulate_grand_total_for_inclusive_tax();\n\t\tthis.calculate_totals();\n\t\tthis._cleanup();\n\t},\n\titem_tax_template: function(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tif(me.frm.updating_party_details) return;\n\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\n\t\tif(item.item_tax_template) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_item_tax_map\",\n\t\t\t\targs: {\n\t\t\t\t\tcompany: me.frm.doc.company,\n\t\t\t\t\titem_tax_template: item.item_tax_template,\n\t\t\t\t\tas_json: true\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\titem.item_tax_rate = r.message;\n\t\t\t\t\t\tme.add_taxes_from_item_tax_template(item.item_tax_rate);\n\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\titem.item_tax_rate = \"{}\";\n\t\t\tme.calculate_taxes_and_totals();\n\t\t}\n\t},\n\tadd_taxes_from_item_tax_template: function(item_tax_map) {\n\t\tlet me = this;\n\n\t\tif (item_tax_map && cint(frappe.defaults.get_default(\"add_taxes_from_item_tax_template\"))) {\n\t\t\tif (typeof (item_tax_map) == \"string\") {\n\t\t\t\titem_tax_map = JSON.parse(item_tax_map);\n\t\t\t}\n\n\t\t\t$.each(item_tax_map, function(tax, rate) {\n\t\t\t\tlet found = (me.frm.doc.taxes || []).find(d => d.account_head === tax);\n\t\t\t\tif (!found) {\n\t\t\t\t\tlet child = frappe.model.add_child(me.frm.doc, \"taxes\");\n\t\t\t\t\tchild.charge_type = \"On Net Total\";\n\t\t\t\t\tchild.account_head = tax;\n\t\t\t\t\tchild.rate = 0;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\tcalculate_item_values: function() {\n\t\tlet me = this;\n\t\tif (!this.discount_amount_applied) {\n\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\t\tfrappe.model.round_floats_in(item);\n\t\t\t\titem.net_rate = item.rate;\n\n\t\t\t\tif ((!item.qty) && me.frm.doc.is_return) {\n\t\t\t\t\titem.amount = flt(item.rate * -1, precision(\"amount\", item));\n\t\t\t\t} else if ((!item.qty) && me.frm.doc.is_debit_note) {\n\t\t\t\t\titem.amount = flt(item.rate, precision(\"amount\", item));\n\t\t\t\t} else {\n\t\t\t\t\titem.amount = flt(item.rate * item.qty, precision(\"amount\", item));\n\t\t\t\t}\n\n\t\t\t\titem.net_amount = item.amount;\n\t\t\t\titem.item_tax_amount = 0.0;\n\t\t\t\titem.total_weight = flt(item.weight_per_unit * item.stock_qty);\n\t\t\t\tme.set_in_company_currency(item, [\"price_list_rate\", \"rate\", \"amount\", \"net_rate\", \"net_amount\"]);\n\t\t\t});\n\t\t}\n\t},\n\n\tset_in_company_currency: function(doc, fields) {\n\t\tvar me = this;\n\t\t$.each(fields, function(i, f) {\n\t\t\tdoc[\"base_\"+f] = flt(flt(doc[f], precision(f, doc)) * me.frm.doc.conversion_rate, precision(\"base_\" + f, doc));\n\t\t});\n\t},\n\n\tinitialize_taxes: function() {\n\t\tvar me = this;\n\n\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\tif (!tax.dont_recompute_tax) {\n\t\t\t\ttax.item_wise_tax_detail = {};\n\t\t\t}\n\t\t\tvar tax_fields = [\"total\", \"tax_amount_after_discount_amount\",\n\t\t\t\t\"tax_amount_for_current_item\", \"grand_total_for_current_item\",\n\t\t\t\t\"tax_fraction_for_current_item\", \"grand_total_fraction_for_current_item\"];\n\n\t\t\tif (cstr(tax.charge_type) != \"Actual\" &&\n\t\t\t\t!(me.discount_amount_applied && me.frm.doc.apply_discount_on==\"Grand Total\")) {\n\t\t\t\ttax_fields.push(\"tax_amount\");\n\t\t\t}\n\n\t\t\t$.each(tax_fields, function(i, fieldname) { tax[fieldname] = 0.0; });\n\n//\t\t\tif (!this.discount_amount_applied && cur_frm) {\n//\t\t\t\tcur_frm.cscript.validate_taxes_and_charges(tax.doctype, tax.name);\n//\t\t\t\tme.validate_inclusive_tax(tax);\n//\t\t\t}\n\t\t\tfrappe.model.round_floats_in(tax);\n\t\t});\n\t},\n\n\tfetch_round_off_accounts: function() {\n\t\tlet me = this;\n\t\tfrappe.flags.round_off_applicable_accounts = [];\n\n\t\tif (me.frm.doc.company) {\n\t\t\treturn frappe.call({\n\t\t\t\t\"method\": \"erpnext.controllers.taxes_and_totals.get_round_off_applicable_accounts\",\n\t\t\t\t\"args\": {\n\t\t\t\t\t\"company\": me.frm.doc.company,\n\t\t\t\t\t\"account_list\": frappe.flags.round_off_applicable_accounts\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tfrappe.flags.round_off_applicable_accounts.push(...r.message);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tdetermine_exclusive_rate: function() {\n\t\tvar me = this;\n\n\t\tvar has_inclusive_tax = false;\n\t\t$.each(me.frm.doc[\"taxes\"] || [], function(i, row) {\n\t\t\tif(cint(row.included_in_print_rate)) has_inclusive_tax = true;\n\t\t});\n\t\tif(has_inclusive_tax==false) return;\n\n\t\t$.each(me.frm.doc[\"items\"] || [], function(n, item) {\n\t\t\tvar item_tax_map = me._load_item_tax_rate(item.item_tax_rate);\n\t\t\tvar cumulated_tax_fraction = 0.0;\n\t\t\tvar total_inclusive_tax_amount_per_qty = 0;\n\t\t\t$.each(me.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\tvar current_tax_fraction = me.get_current_tax_fraction(tax, item_tax_map);\n\t\t\t\ttax.tax_fraction_for_current_item = current_tax_fraction[0];\n\t\t\t\tvar inclusive_tax_amount_per_qty = current_tax_fraction[1];\n\n\t\t\t\tif(i==0) {\n\t\t\t\t\ttax.grand_total_fraction_for_current_item = 1 + tax.tax_fraction_for_current_item;\n\t\t\t\t} else {\n\t\t\t\t\ttax.grand_total_fraction_for_current_item =\n\t\t\t\t\t\tme.frm.doc[\"taxes\"][i-1].grand_total_fraction_for_current_item +\n\t\t\t\t\t\ttax.tax_fraction_for_current_item;\n\t\t\t\t}\n\n\t\t\t\tcumulated_tax_fraction += tax.tax_fraction_for_current_item;\n\t\t\t\ttotal_inclusive_tax_amount_per_qty += inclusive_tax_amount_per_qty * flt(item.qty);\n\t\t\t});\n\n\t\t\tif(!me.discount_amount_applied && item.qty && (total_inclusive_tax_amount_per_qty || cumulated_tax_fraction)) {\n\t\t\t\tvar amount = flt(item.amount) - total_inclusive_tax_amount_per_qty;\n\t\t\t\titem.net_amount = flt(amount / (1 + cumulated_tax_fraction));\n\t\t\t\titem.net_rate = item.qty ? flt(item.net_amount / item.qty, precision(\"net_rate\", item)) : 0;\n\n\t\t\t\tme.set_in_company_currency(item, [\"net_rate\", \"net_amount\"]);\n\t\t\t}\n\t\t});\n\t},\n\n\tget_current_tax_fraction: function(tax, item_tax_map) {\n\t\t// Get tax fraction for calculating tax exclusive amount\n\t\t// from tax inclusive amount\n\t\tvar current_tax_fraction = 0.0;\n\t\tvar inclusive_tax_amount_per_qty = 0;\n\n\t\tif(cint(tax.included_in_print_rate)) {\n\t\t\tvar tax_rate = this._get_tax_rate(tax, item_tax_map);\n\n\t\t\tif(tax.charge_type == \"On Net Total\") {\n\t\t\t\tcurrent_tax_fraction = (tax_rate / 100.0);\n\n\t\t\t} else if(tax.charge_type == \"On Previous Row Amount\") {\n\t\t\t\tcurrent_tax_fraction = (tax_rate / 100.0) *\n\t\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].tax_fraction_for_current_item;\n\n\t\t\t} else if(tax.charge_type == \"On Previous Row Total\") {\n\t\t\t\tcurrent_tax_fraction = (tax_rate / 100.0) *\n\t\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].grand_total_fraction_for_current_item;\n\t\t\t} else if (tax.charge_type == \"On Item Quantity\") {\n\t\t\t\tinclusive_tax_amount_per_qty = flt(tax_rate);\n\t\t\t}\n\t\t}\n\n\t\tif(tax.add_deduct_tax && tax.add_deduct_tax == \"Deduct\") {\n\t\t\tcurrent_tax_fraction *= -1;\n\t\t\tinclusive_tax_amount_per_qty *= -1;\n\t\t}\n\t\treturn [current_tax_fraction, inclusive_tax_amount_per_qty];\n\t},\n\n\t_get_tax_rate: function(tax, item_tax_map) {\n\t\treturn (Object.keys(item_tax_map).indexOf(tax.account_head) != -1) ?\n\t\t\tflt(item_tax_map[tax.account_head], precision(\"rate\", tax)) : tax.rate;\n\t},\n\n\tcalculate_net_total: function() {\n\t\tvar me = this;\n\t\tthis.frm.doc.total_qty = this.frm.doc.total = this.frm.doc.base_total = this.frm.doc.net_total = this.frm.doc.base_net_total = 0.0;\n\n\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\tme.frm.doc.total += item.amount;\n\t\t\tme.frm.doc.total_qty += item.qty;\n\t\t\tme.frm.doc.base_total += item.base_amount;\n\t\t\tme.frm.doc.net_total += item.net_amount;\n\t\t\tme.frm.doc.base_net_total += item.base_net_amount;\n\t\t\t});\n\t},\n\n\tcalculate_shipping_charges: function() {\n\t\t// Do not apply shipping rule for POS\n\t\tif (this.frm.doc.is_pos) {\n\t\t\treturn;\n\t\t}\n\n\t\tfrappe.model.round_floats_in(this.frm.doc, [\"total\", \"base_total\", \"net_total\", \"base_net_total\"]);\n\t\tif (frappe.meta.get_docfield(this.frm.doc.doctype, \"shipping_rule\", this.frm.doc.name)) {\n\t\t\treturn this.shipping_rule();\n\t\t}\n\t},\n\n\tcalculate_taxes: function() {\n\t\tvar me = this;\n\t\tthis.frm.doc.rounding_adjustment = 0;\n\t\tvar actual_tax_dict = {};\n\n\t\t// maintain actual tax rate based on idx\n\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\tif (tax.charge_type == \"Actual\") {\n\t\t\t\tactual_tax_dict[tax.idx] = flt(tax.tax_amount, precision(\"tax_amount\", tax));\n\t\t\t}\n\t\t});\n\n\t\t$.each(this.frm.doc[\"items\"] || [], function(n, item) {\n\t\t\tvar item_tax_map = me._load_item_tax_rate(item.item_tax_rate);\n\t\t\t$.each(me.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\t// tax_amount represents the amount of tax for the current step\n\t\t\t\tvar current_tax_amount = me.get_current_tax_amount(item, tax, item_tax_map);\n\n\t\t\t\t// Adjust divisional loss to the last item\n\t\t\t\tif (tax.charge_type == \"Actual\") {\n\t\t\t\t\tactual_tax_dict[tax.idx] -= current_tax_amount;\n\t\t\t\t\tif (n == me.frm.doc[\"items\"].length - 1) {\n\t\t\t\t\t\tcurrent_tax_amount += actual_tax_dict[tax.idx];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// accumulate tax amount into tax.tax_amount\n\t\t\t\tif (tax.charge_type != \"Actual\" &&\n\t\t\t\t\t!(me.discount_amount_applied && me.frm.doc.apply_discount_on==\"Grand Total\")) {\n\t\t\t\t\ttax.tax_amount += current_tax_amount;\n\t\t\t\t}\n\n\t\t\t\t// store tax_amount for current item as it will be used for\n\t\t\t\t// charge type = 'On Previous Row Amount'\n\t\t\t\ttax.tax_amount_for_current_item = current_tax_amount;\n\n\t\t\t\t// tax amount after discount amount\n\t\t\t\ttax.tax_amount_after_discount_amount += current_tax_amount;\n\n\t\t\t\t// for buying\n\t\t\t\tif(tax.category) {\n\t\t\t\t\t// if just for valuation, do not add the tax amount in total\n\t\t\t\t\t// hence, setting it as 0 for further steps\n\t\t\t\t\tcurrent_tax_amount = (tax.category == \"Valuation\") ? 0.0 : current_tax_amount;\n\n\t\t\t\t\tcurrent_tax_amount *= (tax.add_deduct_tax == \"Deduct\") ? -1.0 : 1.0;\n\t\t\t\t}\n\n\t\t\t\t// note: grand_total_for_current_item contains the contribution of\n\t\t\t\t// item's amount, previously applied tax and the current tax on that item\n\t\t\t\tif(i==0) {\n\t\t\t\t\ttax.grand_total_for_current_item = flt(item.net_amount + current_tax_amount);\n\t\t\t\t} else {\n\t\t\t\t\ttax.grand_total_for_current_item =\n\t\t\t\t\t\tflt(me.frm.doc[\"taxes\"][i-1].grand_total_for_current_item + current_tax_amount);\n\t\t\t\t}\n\n\t\t\t\t// set precision in the last item iteration\n\t\t\t\tif (n == me.frm.doc[\"items\"].length - 1) {\n\t\t\t\t\tme.set_in_company_currency(tax,\n\t\t\t\t\t\t[\"tax_amount\", \"tax_amount_after_discount_amount\"]);\n\t\t\t\t\t// in tax.total, accumulate grand total for each item\n\t\t\t\t\tme.set_cumulative_total(i, tax);\n\n\t\t\t\t\tme.set_in_company_currency(tax, [\"total\"]);\n\n\t\t\t\t\t// adjust Discount Amount loss in last tax iteration\n\t\t\t\t\tif ((i == me.frm.doc[\"taxes\"].length - 1) && me.discount_amount_applied\n\t\t\t\t\t\t&& me.frm.doc.apply_discount_on == \"Grand Total\" && me.frm.doc.discount_amount) {\n\t\t\t\t\t\tme.frm.doc.rounding_adjustment = flt(me.frm.doc.grand_total -\n\t\t\t\t\t\t\tflt(me.frm.doc.discount_amount) - tax.total, precision(\"rounding_adjustment\"));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t},\n\n\tset_cumulative_total: function(row_idx, tax) {\n\t\tvar tax_amount = tax.tax_amount_after_discount_amount;\n\t\tif (tax.category == 'Valuation') {\n\t\t\ttax_amount = 0;\n\t\t}\n\n\t\tif (tax.add_deduct_tax == \"Deduct\") { tax_amount = -1*tax_amount; }\n\n\t\tif(row_idx==0) {\n\t\t\ttax.total = flt(this.frm.doc.net_total + tax_amount, precision(\"total\", tax));\n\t\t} else {\n\t\t\ttax.total = flt(this.frm.doc[\"taxes\"][row_idx-1].total + tax_amount, precision(\"total\", tax));\n\t\t}\n\t},\n\n\t_load_item_tax_rate: function(item_tax_rate) {\n\t\treturn item_tax_rate ? JSON.parse(item_tax_rate) : {};\n\t},\n\n\tget_current_tax_amount: function(item, tax, item_tax_map) {\n\t\tvar tax_rate = this._get_tax_rate(tax, item_tax_map);\n\t\tvar current_tax_amount = 0.0;\n\n\t\t// To set row_id by default as previous row.\n\t\tif([\"On Previous Row Amount\", \"On Previous Row Total\"].includes(tax.charge_type)) {\n\t\t\tif (tax.idx === 1) {\n\t\t\t\tfrappe.throw(\n\t\t\t\t\t__(\"Cannot select charge type as 'On Previous Row Amount' or 'On Previous Row Total' for first row\"));\n\t\t\t}\n\t\t\tif (!tax.row_id) {\n\t\t\t\ttax.row_id = tax.idx - 1;\n\t\t\t}\n\t\t}\n\t\tif(tax.charge_type == \"Actual\") {\n\t\t\t// distribute the tax amount proportionally to each item row\n\t\t\tvar actual = flt(tax.tax_amount, precision(\"tax_amount\", tax));\n\t\t\tcurrent_tax_amount = this.frm.doc.net_total ?\n\t\t\t\t((item.net_amount / this.frm.doc.net_total) * actual) : 0.0;\n\n\t\t} else if(tax.charge_type == \"On Net Total\") {\n\t\t\tcurrent_tax_amount = (tax_rate / 100.0) * item.net_amount;\n\t\t} else if(tax.charge_type == \"On Previous Row Amount\") {\n\t\t\tcurrent_tax_amount = (tax_rate / 100.0) *\n\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].tax_amount_for_current_item;\n\n\t\t} else if(tax.charge_type == \"On Previous Row Total\") {\n\t\t\tcurrent_tax_amount = (tax_rate / 100.0) *\n\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].grand_total_for_current_item;\n\t\t} else if (tax.charge_type == \"On Item Quantity\") {\n\t\t\tcurrent_tax_amount = tax_rate * item.qty;\n\t\t}\n\n\t\tif (!tax.dont_recompute_tax) {\n\t\t\tthis.set_item_wise_tax(item, tax, tax_rate, current_tax_amount);\n\t\t}\n\n\t\treturn current_tax_amount;\n\t},\n\n\tset_item_wise_tax: function(item, tax, tax_rate, current_tax_amount) {\n\t\t// store tax breakup for each item\n\t\tlet tax_detail = tax.item_wise_tax_detail;\n\t\tlet key = item.item_code || item.item_name;\n\n\t\tif(typeof (tax_detail) == \"string\") {\n\t\t\ttax.item_wise_tax_detail = JSON.parse(tax.item_wise_tax_detail);\n\t\t\ttax_detail = tax.item_wise_tax_detail;\n\t\t}\n\n\t\tlet item_wise_tax_amount = current_tax_amount * this.frm.doc.conversion_rate;\n\t\tif (tax_detail && tax_detail[key])\n\t\t\titem_wise_tax_amount += tax_detail[key][1];\n\n\t\ttax_detail[key] = [tax_rate, flt(item_wise_tax_amount, precision(\"base_tax_amount\", tax))];\n\t},\n\tmanipulate_grand_total_for_inclusive_tax: function() {\n\t\tvar me = this;\n\t\t// if fully inclusive taxes and diff\n\t\tif (this.frm.doc[\"taxes\"] && this.frm.doc[\"taxes\"].length) {\n\t\t\tvar any_inclusive_tax = false;\n\t\t\t$.each(this.frm.doc.taxes || [], function(i, d) {\n\t\t\t\tif(cint(d.included_in_print_rate)) any_inclusive_tax = true;\n\t\t\t});\n\t\t\tif (any_inclusive_tax) {\n\t\t\t\tvar last_tax = me.frm.doc[\"taxes\"].slice(-1)[0];\n\t\t\t\tvar non_inclusive_tax_amount = frappe.utils.sum($.map(this.frm.doc.taxes || [],\n\t\t\t\t\tfunction(d) {\n\t\t\t\t\t\tif(!d.included_in_print_rate) {\n\t\t\t\t\t\t\treturn flt(d.tax_amount_after_discount_amount);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t));\n\t\t\t\tvar diff = me.frm.doc.total + non_inclusive_tax_amount\n\t\t\t\t\t- flt(last_tax.total, precision(\"grand_total\"));\n\n\t\t\t\tif(me.discount_amount_applied && me.frm.doc.discount_amount) {\n\t\t\t\t\tdiff -= flt(me.frm.doc.discount_amount);\n\t\t\t\t}\n\n\t\t\t\tdiff = flt(diff, precision(\"rounding_adjustment\"));\n\n\t\t\t\tif ( diff && Math.abs(diff) <= (5.0 / Math.pow(10, precision(\"tax_amount\", last_tax))) ) {\n\t\t\t\t\tme.frm.doc.rounding_adjustment = diff;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tcalculate_totals: function() {\n\t\t// Changing sequence can because of rounding adjustment issue and on-screen discrepancy\n\t\tvar me = this;\n\t\tvar tax_count = this.frm.doc[\"taxes\"] ? this.frm.doc[\"taxes\"].length : 0;\n\t\tthis.frm.doc.grand_total = flt(tax_count\n\t\t\t? this.frm.doc[\"taxes\"][tax_count - 1].total + flt(this.frm.doc.rounding_adjustment)\n\t\t\t: this.frm.doc.net_total);\n\n\t\tif(in_list([\"Quotation\", \"Sales Order\", \"Delivery Note\", \"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype)) {\n\t\t\tthis.frm.doc.base_grand_total = (this.frm.doc.total_taxes_and_charges) ?\n\t\t\t\tflt(this.frm.doc.grand_total * this.frm.doc.conversion_rate) : this.frm.doc.base_net_total;\n\t\t} else {\n\t\t\t// other charges added/deducted\n\t\t\tthis.frm.doc.taxes_and_charges_added = this.frm.doc.taxes_and_charges_deducted = 0.0;\n\t\t\tif(tax_count) {\n\t\t\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\t\tif (in_list([\"Valuation and Total\", \"Total\"], tax.category)) {\n\t\t\t\t\t\tif(tax.add_deduct_tax == \"Add\") {\n\t\t\t\t\t\t\tme.frm.doc.taxes_and_charges_added += flt(tax.tax_amount_after_discount_amount);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tme.frm.doc.taxes_and_charges_deducted += flt(tax.tax_amount_after_discount_amount);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tfrappe.model.round_floats_in(this.frm.doc,\n\t\t\t\t\t[\"taxes_and_charges_added\", \"taxes_and_charges_deducted\"]);\n\t\t\t}\n\n\t\t\tthis.frm.doc.base_grand_total = flt((this.frm.doc.taxes_and_charges_added || this.frm.doc.taxes_and_charges_deducted) ?\n\t\t\t\tflt(this.frm.doc.grand_total * this.frm.doc.conversion_rate) : this.frm.doc.base_net_total);\n\n\t\t\tthis.set_in_company_currency(this.frm.doc,\n\t\t\t\t[\"taxes_and_charges_added\", \"taxes_and_charges_deducted\"]);\n\t\t}\n\n\t\tthis.frm.doc.total_taxes_and_charges = flt(this.frm.doc.grand_total - this.frm.doc.net_total\n\t\t\t- flt(this.frm.doc.rounding_adjustment), precision(\"total_taxes_and_charges\"));\n\n\t\tthis.set_in_company_currency(this.frm.doc, [\"total_taxes_and_charges\", \"rounding_adjustment\"]);\n\n\t\t// Round grand total as per precision\n\t\tfrappe.model.round_floats_in(this.frm.doc, [\"grand_total\", \"base_grand_total\"]);\n\n\t\t// rounded totals\n\t\tthis.set_rounded_total();\n\t},\n\n\tset_rounded_total: function() {\n\t\tvar disable_rounded_total = 0;\n\t\tif(frappe.meta.get_docfield(this.frm.doc.doctype, \"disable_rounded_total\", this.frm.doc.name)) {\n\t\t\tdisable_rounded_total = this.frm.doc.disable_rounded_total;\n\t\t} else if (frappe.sys_defaults.disable_rounded_total) {\n\t\t\tdisable_rounded_total = frappe.sys_defaults.disable_rounded_total;\n\t\t}\n\n\t\tif (cint(disable_rounded_total)) {\n\t\t\tthis.frm.doc.rounded_total = 0;\n\t\t\tthis.frm.doc.base_rounded_total = 0;\n\t\t\treturn;\n\t\t}\n\n\t\tif(frappe.meta.get_docfield(this.frm.doc.doctype, \"rounded_total\", this.frm.doc.name)) {\n\t\t\tthis.frm.doc.rounded_total = round_based_on_smallest_currency_fraction(this.frm.doc.grand_total,\n\t\t\t\tthis.frm.doc.currency, precision(\"rounded_total\"));\n\t\t\tthis.frm.doc.rounding_adjustment += flt(this.frm.doc.rounded_total - this.frm.doc.grand_total,\n\t\t\t\tprecision(\"rounding_adjustment\"));\n\n\t\t\tthis.set_in_company_currency(this.frm.doc, [\"rounding_adjustment\", \"rounded_total\"]);\n\t\t}\n\t},\n\n\t_cleanup: function() {\n\t\tthis.frm.doc.base_in_words = this.frm.doc.in_words = \"\";\n\n\t\tif(this.frm.doc[\"items\"] && this.frm.doc[\"items\"].length) {\n\t\t\tif(!frappe.meta.get_docfield(this.frm.doc[\"items\"][0].doctype, \"item_tax_amount\", this.frm.doctype)) {\n\t\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\t\t\tdelete item[\"item_tax_amount\"];\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif(this.frm.doc[\"taxes\"] && this.frm.doc[\"taxes\"].length) {\n\t\t\tvar temporary_fields = [\"tax_amount_for_current_item\", \"grand_total_for_current_item\",\n\t\t\t\t\"tax_fraction_for_current_item\", \"grand_total_fraction_for_current_item\"];\n\n\t\t\tif(!frappe.meta.get_docfield(this.frm.doc[\"taxes\"][0].doctype, \"tax_amount_after_discount_amount\", this.frm.doctype)) {\n\t\t\t\ttemporary_fields.push(\"tax_amount_after_discount_amount\");\n\t\t\t}\n\n\t\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\t$.each(temporary_fields, function(i, fieldname) {\n\t\t\t\t\tdelete tax[fieldname];\n\t\t\t\t});\n\n\t\t\t\tif (!tax.dont_recompute_tax) {\n\t\t\t\t\ttax.item_wise_tax_detail = JSON.stringify(tax.item_wise_tax_detail);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tset_discount_amount: function() {\n\t\tif(this.frm.doc.additional_discount_percentage) {\n\t\t\tthis.frm.doc.discount_amount = flt(flt(this.frm.doc[frappe.scrub(this.frm.doc.apply_discount_on)])\n\t\t\t\t* this.frm.doc.additional_discount_percentage / 100, precision(\"discount_amount\"));\n\t\t}\n\t},\n\n\tapply_discount_amount: function() {\n\t\tvar me = this;\n\t\tvar distributed_amount = 0.0;\n\t\tthis.frm.doc.base_discount_amount = 0.0;\n\n\t\tif (this.frm.doc.discount_amount) {\n\t\t\tif(!this.frm.doc.apply_discount_on)\n\t\t\t\tfrappe.throw(__(\"Please select Apply Discount On\"));\n\n\t\t\tthis.frm.doc.base_discount_amount = flt(this.frm.doc.discount_amount * this.frm.doc.conversion_rate,\n\t\t\t\tprecision(\"base_discount_amount\"));\n\n\t\t\tvar total_for_discount_amount = this.get_total_for_discount_amount();\n\t\t\tvar net_total = 0;\n\t\t\t// calculate item amount after Discount Amount\n\t\t\tif (total_for_discount_amount) {\n\t\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\t\t\tdistributed_amount = flt(me.frm.doc.discount_amount) * item.net_amount / total_for_discount_amount;\n\t\t\t\t\titem.net_amount = flt(item.net_amount - distributed_amount,\n\t\t\t\t\t\tprecision(\"base_amount\", item));\n\t\t\t\t\tnet_total += item.net_amount;\n\n\t\t\t\t\t// discount amount rounding loss adjustment if no taxes\n\t\t\t\t\tif ((!(me.frm.doc.taxes || []).length || total_for_discount_amount==me.frm.doc.net_total || (me.frm.doc.apply_discount_on == \"Net Total\"))\n\t\t\t\t\t\t\t&& i == (me.frm.doc.items || []).length - 1) {\n\t\t\t\t\t\tvar discount_amount_loss = flt(me.frm.doc.net_total - net_total\n\t\t\t\t\t\t\t- me.frm.doc.discount_amount, precision(\"net_total\"));\n\t\t\t\t\t\titem.net_amount = flt(item.net_amount + discount_amount_loss,\n\t\t\t\t\t\t\tprecision(\"net_amount\", item));\n\t\t\t\t\t}\n\t\t\t\t\titem.net_rate = item.qty ? flt(item.net_amount / item.qty, precision(\"net_rate\", item)) : 0;\n\t\t\t\t\tme.set_in_company_currency(item, [\"net_rate\", \"net_amount\"]);\n\t\t\t\t});\n\n\t\t\t\tthis.discount_amount_applied = true;\n\t\t\t\tthis._calculate_taxes_and_totals();\n\t\t\t}\n\t\t}\n\t},\n\n\tget_total_for_discount_amount: function() {\n\t\tif(this.frm.doc.apply_discount_on == \"Net Total\") {\n\t\t\treturn this.frm.doc.net_total;\n\t\t} else {\n\t\t\tvar total_actual_tax = 0.0;\n\t\t\tvar actual_taxes_dict = {};\n\n\t\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\tif (in_list([\"Actual\", \"On Item Quantity\"], tax.charge_type)) {\n\t\t\t\t\tvar tax_amount = (tax.category == \"Valuation\") ? 0.0 : tax.tax_amount;\n\t\t\t\t\ttax_amount *= (tax.add_deduct_tax == \"Deduct\") ? -1.0 : 1.0;\n\t\t\t\t\tactual_taxes_dict[tax.idx] = tax_amount;\n\t\t\t\t} else if (actual_taxes_dict[tax.row_id] !== null) {\n\t\t\t\t\tvar actual_tax_amount = flt(actual_taxes_dict[tax.row_id]) * flt(tax.rate) / 100;\n\t\t\t\t\tactual_taxes_dict[tax.idx] = actual_tax_amount;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t$.each(actual_taxes_dict, function(key, value) {\n\t\t\t\tif (value) total_actual_tax += value;\n\t\t\t});\n\n\t\t\treturn flt(this.frm.doc.grand_total - total_actual_tax, precision(\"grand_total\"));\n\t\t}\n\t},\n\n\tcalculate_total_advance: function(update_paid_amount) {\n\t\tvar total_allocated_amount = frappe.utils.sum($.map(this.frm.doc[\"advances\"] || [], function(adv) {\n\t\t\treturn flt(adv.allocated_amount, precision(\"allocated_amount\", adv));\n\t\t}));\n\t\tthis.frm.doc.total_advance = flt(total_allocated_amount, precision(\"total_advance\"));\n\n\t\tif (this.frm.doc.write_off_outstanding_amount_automatically) {\n\t\t\tthis.frm.doc.write_off_amount = 0;\n\t\t}\n\n\t\tthis.calculate_outstanding_amount(update_paid_amount);\n\t\tthis.calculate_write_off_amount();\n\t},\n\n\tis_internal_invoice: function() {\n\t\tif (['Sales Invoice', 'Purchase Invoice'].includes(this.frm.doc.doctype)) {\n\t\t\tif (this.frm.doc.company === this.frm.doc.represents_company) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t},\n\n\tcalculate_outstanding_amount: function(update_paid_amount) {\n\t\t// NOTE:\n\t\t// paid_amount and write_off_amount is only for POS/Loyalty Point Redemption Invoice\n\t\t// total_advance is only for non POS Invoice\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype) && this.frm.doc.is_return){\n\t\t\tthis.calculate_paid_amount();\n\t\t}\n\n\t\tif (this.frm.doc.is_return || (this.frm.doc.docstatus > 0) || this.is_internal_invoice()) return;\n\n\t\tfrappe.model.round_floats_in(this.frm.doc, [\"grand_total\", \"total_advance\", \"write_off_amount\"]);\n\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\", \"Purchase Invoice\"], this.frm.doc.doctype)) {\n\t\t\tlet grand_total = this.frm.doc.rounded_total || this.frm.doc.grand_total;\n\t\t\tlet base_grand_total = this.frm.doc.base_rounded_total || this.frm.doc.base_grand_total;\n\n\t\t\tif(this.frm.doc.party_account_currency == this.frm.doc.currency) {\n\t\t\t\tvar total_amount_to_pay = flt((grand_total - this.frm.doc.total_advance\n\t\t\t\t\t- this.frm.doc.write_off_amount), precision(\"grand_total\"));\n\t\t\t} else {\n\t\t\t\tvar total_amount_to_pay = flt(\n\t\t\t\t\t(flt(base_grand_total, precision(\"base_grand_total\"))\n\t\t\t\t\t\t- this.frm.doc.total_advance - this.frm.doc.base_write_off_amount),\n\t\t\t\t\tprecision(\"base_grand_total\")\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tfrappe.model.round_floats_in(this.frm.doc, [\"paid_amount\"]);\n\t\t\tthis.set_in_company_currency(this.frm.doc, [\"paid_amount\"]);\n\n\t\t\tif(this.frm.refresh_field){\n\t\t\t\tthis.frm.refresh_field(\"paid_amount\");\n\t\t\t\tthis.frm.refresh_field(\"base_paid_amount\");\n\t\t\t}\n\n\t\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype)) {\n\t\t\t\tlet total_amount_for_payment = (this.frm.doc.redeem_loyalty_points && this.frm.doc.loyalty_amount)\n\t\t\t\t\t? flt(total_amount_to_pay - this.frm.doc.loyalty_amount, precision(\"base_grand_total\"))\n\t\t\t\t\t: total_amount_to_pay;\n\t\t\t\tthis.set_default_payment(total_amount_for_payment, update_paid_amount);\n\t\t\t\tthis.calculate_paid_amount();\n\t\t\t}\n\t\t\tthis.calculate_change_amount();\n\n\t\t\tvar paid_amount = (this.frm.doc.party_account_currency == this.frm.doc.currency) ?\n\t\t\t\tthis.frm.doc.paid_amount : this.frm.doc.base_paid_amount;\n\t\t\tthis.frm.doc.outstanding_amount =  flt(total_amount_to_pay - flt(paid_amount) +\n\t\t\t\tflt(this.frm.doc.change_amount * this.frm.doc.conversion_rate), precision(\"outstanding_amount\"));\n\t\t}\n\t},\n\n\tset_total_amount_to_default_mop: function() {\n\t\tlet grand_total = this.frm.doc.rounded_total || this.frm.doc.grand_total;\n\t\tlet base_grand_total = this.frm.doc.base_rounded_total || this.frm.doc.base_grand_total;\n\n\t\tif(this.frm.doc.party_account_currency == this.frm.doc.currency) {\n\t\t\tvar total_amount_to_pay = flt((grand_total - this.frm.doc.total_advance\n\t\t\t\t- this.frm.doc.write_off_amount), precision(\"grand_total\"));\n\t\t} else {\n\t\t\tvar total_amount_to_pay = flt(\n\t\t\t\t(flt(base_grand_total, precision(\"base_grand_total\"))\n\t\t\t\t\t- this.frm.doc.total_advance - this.frm.doc.base_write_off_amount),\n\t\t\t\tprecision(\"base_grand_total\")\n\t\t\t);\n\t\t}\n\t\tthis.frm.doc.payments.find(pay => {\n\t\t\tif (pay.default) {\n\t\t\t\tpay.amount = total_amount_to_pay;\n\t\t\t}\n\t\t});\n\t\tthis.frm.refresh_fields();\n\t},\n\n\tset_default_payment: function(total_amount_to_pay, update_paid_amount) {\n\t\tvar me = this;\n\t\tvar payment_status = true;\n\t\tif(this.frm.doc.is_pos && (update_paid_amount===undefined || update_paid_amount)) {\n\t\t\t$.each(this.frm.doc['payments'] || [], function(index, data) {\n\t\t\t\tif(data.default && payment_status && total_amount_to_pay > 0) {\n\t\t\t\t\tlet base_amount = flt(total_amount_to_pay, precision(\"base_amount\", data));\n\t\t\t\t\tfrappe.model.set_value(data.doctype, data.name, \"base_amount\", base_amount);\n\t\t\t\t\tlet amount = flt(total_amount_to_pay / me.frm.doc.conversion_rate, precision(\"amount\", data));\n\t\t\t\t\tfrappe.model.set_value(data.doctype, data.name, \"amount\", amount);\n\t\t\t\t\tpayment_status = false;\n\t\t\t\t} else if(me.frm.doc.paid_amount) {\n\t\t\t\t\tfrappe.model.set_value(data.doctype, data.name, \"amount\", 0.0);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tcalculate_paid_amount: function() {\n\t\tvar me = this;\n\t\tvar paid_amount = 0.0;\n\t\tvar base_paid_amount = 0.0;\n\t\tif(this.frm.doc.is_pos) {\n\t\t\t$.each(this.frm.doc['payments'] || [], function(index, data){\n\t\t\t\tdata.base_amount = flt(data.amount * me.frm.doc.conversion_rate, precision(\"base_amount\", data));\n\t\t\t\tpaid_amount += data.amount;\n\t\t\t\tbase_paid_amount += data.base_amount;\n\t\t\t});\n\t\t} else if(!this.frm.doc.is_return){\n\t\t\tthis.frm.doc.payments = [];\n\t\t}\n\t\tif (this.frm.doc.redeem_loyalty_points && this.frm.doc.loyalty_amount) {\n\t\t\tbase_paid_amount += this.frm.doc.loyalty_amount;\n\t\t\tpaid_amount += flt(this.frm.doc.loyalty_amount / me.frm.doc.conversion_rate, precision(\"paid_amount\"));\n\t\t}\n\n\t\tthis.frm.set_value('paid_amount', flt(paid_amount, precision(\"paid_amount\")));\n\t\tthis.frm.set_value('base_paid_amount', flt(base_paid_amount, precision(\"base_paid_amount\")));\n\t},\n\n\tcalculate_change_amount: function() {\n\t\tthis.frm.doc.change_amount = 0.0;\n\t\tthis.frm.doc.base_change_amount = 0.0;\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype)\n\t\t\t&& this.frm.doc.paid_amount > this.frm.doc.grand_total && !this.frm.doc.is_return) {\n\n\t\t\tvar payment_types = $.map(this.frm.doc.payments, function(d) { return d.type; });\n\t\t\tif (in_list(payment_types, 'Cash')) {\n\t\t\t\tvar grand_total = this.frm.doc.rounded_total || this.frm.doc.grand_total;\n\t\t\t\tvar base_grand_total = this.frm.doc.base_rounded_total || this.frm.doc.base_grand_total;\n\n\t\t\t\tthis.frm.doc.change_amount = flt(this.frm.doc.paid_amount - grand_total,\n\t\t\t\t\tprecision(\"change_amount\"));\n\n\t\t\t\tthis.frm.doc.base_change_amount = flt(this.frm.doc.base_paid_amount -\n\t\t\t\t\tbase_grand_total, precision(\"base_change_amount\"));\n\t\t\t}\n\t\t}\n\t},\n\n\tcalculate_write_off_amount: function() {\n\t\tif (this.frm.doc.write_off_outstanding_amount_automatically) {\n\t\t\tthis.frm.doc.write_off_amount = flt(this.frm.doc.outstanding_amount, precision(\"write_off_amount\"));\n\t\t\tthis.frm.doc.base_write_off_amount = flt(this.frm.doc.write_off_amount * this.frm.doc.conversion_rate,\n\t\t\t\tprecision(\"base_write_off_amount\"));\n\n\t\t\tthis.calculate_outstanding_amount(false);\n\t\t}\n\n\t}\n});\n"],"names":["frappe","provide","care","ReceivingController","ui","form","Controller","extend","setup","frm","cdt","cdn","on","this","cscript","tax_table","cur_frm","calculate_taxes_and_totals","set_dynamic_labels","doctype","doc","additional_discount_percentage","trigger","onload","me","fields_dict","grid","get_field","set_query","set_query_for_item_tax_template","onload_post_render","__islocal","taxes","length","__onload","load_after_mapping","company","is_pos","after_ajax","apply_default_taxes","item","get_doc","item_code","let","filters","valid_from","transaction_date","bill_date","posting_date","item_group","tax_category","query","taxes_and_charges_field","meta","get_docfield","name","taxes_and_charges","call","method","args","master_doctype","options","tax_template","debounce","callback","r","exc","message","run_serially","set_value","validate","master_name","shipping_rule","tax","add_child","refresh_field","async","update_paid_amount","discount_amount_applied","_calculate_taxes_and_totals","calculate_discount_amount","calculate_shipping_charges","in_list","docstatus","is_return","calculate_total_advance","set_total_amount_to_default_mop","calculate_paid_amount","refresh_fields","set_discount_amount","apply_discount_amount","calculate_item_values","initialize_taxes","determine_exclusive_rate","calculate_net_total","calculate_taxes","manipulate_grand_total_for_inclusive_tax","calculate_totals","_cleanup","item_tax_template","updating_party_details","as_json","item_tax_rate","add_taxes_from_item_tax_template","item_tax_map","cint","defaults","get_default","JSON","parse","$","each","rate","find","d","account_head","child","model","charge_type","i","round_floats_in","net_rate","qty","amount","flt","precision","is_debit_note","net_amount","item_tax_amount","total_weight","weight_per_unit","stock_qty","set_in_company_currency","fields","f","conversion_rate","dont_recompute_tax","item_wise_tax_detail","tax_fields","cstr","apply_discount_on","push","fieldname","fetch_round_off_accounts","flags","round_off_applicable_accounts","account_list","ref","has_inclusive_tax","row","included_in_print_rate","n","_load_item_tax_rate","cumulated_tax_fraction","total_inclusive_tax_amount_per_qty","current_tax_fraction","get_current_tax_fraction","tax_fraction_for_current_item","inclusive_tax_amount_per_qty","grand_total_fraction_for_current_item","tax_rate","_get_tax_rate","row_id","add_deduct_tax","Object","keys","indexOf","total_qty","total","base_total","net_total","base_net_total","base_amount","base_net_amount","rounding_adjustment","actual_tax_dict","idx","tax_amount","current_tax_amount","get_current_tax_amount","tax_amount_for_current_item","tax_amount_after_discount_amount","category","grand_total_for_current_item","set_cumulative_total","discount_amount","grand_total","row_idx","includes","throw","__","actual","set_item_wise_tax","tax_detail","key","item_name","item_wise_tax_amount","any_inclusive_tax","last_tax","slice","non_inclusive_tax_amount","utils","sum","map","diff","Math","abs","pow","tax_count","base_grand_total","taxes_and_charges_added","taxes_and_charges_deducted","total_taxes_and_charges","set_rounded_total","disable_rounded_total","sys_defaults","rounded_total","base_rounded_total","round_based_on_smallest_currency_fraction","currency","base_in_words","in_words","temporary_fields","stringify","scrub","distributed_amount","base_discount_amount","total_for_discount_amount","get_total_for_discount_amount","items","discount_amount_loss","total_actual_tax","actual_taxes_dict","actual_tax_amount","value","total_allocated_amount","adv","allocated_amount","total_advance","write_off_outstanding_amount_automatically","write_off_amount","calculate_outstanding_amount","calculate_write_off_amount","is_internal_invoice","represents_company","party_account_currency","total_amount_to_pay","base_write_off_amount","total_amount_for_payment","redeem_loyalty_points","loyalty_amount","set_default_payment","calculate_change_amount","paid_amount","base_paid_amount","outstanding_amount","change_amount","payments","pay","default","payment_status","undefined","index","data","base_change_amount","payment_types","type"],"mappings":"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"}